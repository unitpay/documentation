# Обработчик платежа

По мере выполнения платежа мы уведомляем платформу магазина о статусе оплаты, последовательно отправляя GET запросы на URL обработчика.

![](../.gitbook/assets/image%20%2844%29.png)

_**Важно**: домен в обработчике платежей должен полностью совпадать с тем, который вы добавляете к нам в систему в качестве проекта_

#### Методы

**CHECK:** проверка возможности оказания услуги абоненту, запрос отправляется до прохождения оплаты. Вы должны подтвердить готовность системы \(проверить корректность суммы платежа, существование счета в БД и т. д.\)

**PAY:** уведомление об успешном списании, вы должны оказать услугу абоненту. При любой ошибке на данном этапе \(например, не доступна БД\) платеж получает статус «Не завершен». После устранения проблем вы можете повторно провести платеж в интерфейсе статистики. Деньги зачисляются на баланс партнера независимо от ответа обработчика

**PREAUTH**: уведомление в платежах с преавторизацией, когда средства успешно заблокированы. **Важно**! Не следует оказывать услугу или выдавать товар плательщику при получении такого уведомления. Списание средств и оказание услуги следует совершать при выполнении confirmPayment

**ERROR:** ошибка платежа на любом из этапов. Если ошибка вызвана пустым/ошибочным ответом сервера партнера, то запрос отправлен не будет. Следует учесть, что данный статус не конечный и возможны ситуации, когда после запроса ERROR может последовать запрос PAY.

```http
https://адрес_вашего_обработчика?
     method=check 
     params[account]=userId 
     params[date]=2012-10-01 12:32:00 
     params[operator]=beeline 
     params[paymentType]=mc 
     params[projectId]=1 
     params[phone]=9XXXXXXXXX 
     params[payerSum]=10.00 
     params[payerCurrency]=RUB 
     params[signature]=9bdf52a4830779a1383ac24f1b3ed054 
     params[orderSum]=10.00 
     params[orderCurrency]=RUB 
     params[unitpayId]=1234567 
     params[test]=0
```

|  | Значение | Описание |
| :--- | :--- | :--- |
| **method** | string | check — запрос на проверку состояния абонента     pay — уведомление о списании     error — уведомление об ошибке |
| **unitpayId**  | число | Внутренний номер платежа в UnitPay |
| **projectId**  | число | ID проекта в UnitPay |
| **account**  | string | Идентификатор абонента в системе партнера |
| **payerSum** | число | Сумма списания с лицевого счета абонента |
| **payerCurrency** | string | Валюта списания с лицевого счета абонента по стандарту ISO 4217 \(RUB, UAH, BYN, EUR, USD\)    |
| **profit** | число | Ваш доход с данного платежа, в рублях |
| **phone** | число | Телефон плательщика \(передается только для мобильных платежей\) |
| **paymentType** | string | [Код платежной системы](../book-of-reference/payment-system-codes.md) |
| **orderSum** | число | Сумма заказа.  **Обязательно сверяйте поступившее значение с оригинальной суммой заказа** |
| **orderCurrency** | string | Валюта заказа по стандарту ISO 4217 \(RUB, UAH, BYN, EUR, USD\).  **Обязательно сверяйте поступившее значение с оригинальной валютой заказа** |
| **operator** | string | Буквенный [код оператора](../book-of-reference/operator-codes.md) |
| **date** | string | Дата платежа в формате YYYY-mm-dd HH:ii:ss \(например 2012-10-01 12:32:00\) |
| **errorMessage** | string | Детализация ошибки \(только для метода error\) |
| **test** | число | Признак тестового режима, если запрос делается с использованием механизма "тестового запроса", то значение будет равно 1. Для реальных платежей значение всегда 0 |
| **3ds** | число | Признак наличия 3-DS для операций по карте, флаг присутствует при PAY уведомлениях |
| **subscriptionId** | число | Идентификатор подписки, возвращается после успешной оплаты установочного платежа по подписке. Присутствует при PREAUTH и PAY уведомлениях |
| **signature** | string | Цифровая подпись. Образуется как sha256\(method + "{up}" + params + "{up}" + secretKey\),  где **sha256** - метод шифрования; **"{up}"** - разделитель параметров в хеш-функции; **method** - тип вызова \(check, pay, error\); **params** - значения параметров из массива params, объединенные разделителем "{up}". Все параметры должны быть предварительно отсортированы по ключу, в склейке не участвуют параметры sign и signature; **secretKey** - секретный ключ проекта \(доступен в личном кабинете\);  Пример расчета подписи для запроса [**http://partnerUrl?method=check & params\[b\]=bob & params\[c\]=sam & params\[a\]=tod**](http://partnerurl/?method=check%20&%20params[b]=bob&params[c]=sam&params[a]=tod)и секретного ключа **"a1b1c1d1"**  **sha256**\("check{up}tod{up}bob{up}sam{up}a1b1c1d1"\) |

**Пример формирования цифровой подписи на PHP:**

```text
function getFormSignature($account, $currency, $desc, $sum, $secretKey) {
    $hashStr = $account.'{up}'.$currency.'{up}'.$desc.'{up}'.$sum.'{up}'.$secretKey;
    return hash('sha256', $hashStr);
}
```

**Пример формирования цифровой подписи на Perl:**

```text
sub getSignature {
    my ($method, $params, $secretKey) = @_;
    delete $params-&gt;{sign};
    delete $params-&gt;{signature};
    my $s = $method;
    foreach my $key (sort keys %{$params}) {
        $s .= '{up}' . $params-&gt;{$key};
    }
    $s .= '{up}' . $secretKey;
    use Digest::SHA qw(sha256_hex);
    return sha256_hex($s);
}
```

Всегда проверяйте [IP адреса](../book-of-reference/ip-addresses.md), с которых приходят запросы к обработчику платежей

**ВАЖНО:** в системе партнера не должно быть двух разных платежей с одним unitpayId. При получении повторного запроса CHECK или PAY необходимо вернуть результат выполнения предыдущего запроса, ничего не пополняя/зачисляя

#### Успешный ответ

```text
{"result": {
    "message": "Запрос успешно обработан"
}}
```

|  | Значение | Описание |
| :--- | :--- | :--- |
| **message** | string | Текстовый статус выполнения запроса. |

#### Ошибочный ответ

```text
{"error": {
    "message": "Описание ошибки"
}}
```

<table>
  <thead>
    <tr>
      <th style="text-align:left"></th>
      <th style="text-align:left">&#x417;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x435;</th>
      <th style="text-align:left">&#x41E;&#x43F;&#x438;&#x441;&#x430;&#x43D;&#x438;&#x435;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align:left"><b>message</b>
      </td>
      <td style="text-align:left">string</td>
      <td style="text-align:left">
        <p>&#x418;&#x43D;&#x444;&#x43E;&#x440;&#x43C;&#x430;&#x446;&#x438;&#x44F;
          &#x441; &#x43E;&#x43F;&#x438;&#x441;&#x430;&#x43D;&#x438;&#x435;&#x43C;
          &#x43E;&#x448;&#x438;&#x431;&#x43A;&#x438; &#x444;&#x43E;&#x440;&#x43C;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x43D;&#x438;&#x44F;
          &#x43F;&#x43B;&#x430;&#x442;&#x435;&#x436;&#x430;.</p>
        <p>&#x41F;&#x440;&#x438; &#x438;&#x441;&#x43F;&#x43E;&#x43B;&#x44C;&#x437;&#x43E;&#x432;&#x430;&#x43D;&#x438;&#x438;
          &#x444;&#x43E;&#x440;&#x43C;&#x44B; &#x43E;&#x43F;&#x43B;&#x430;&#x442;&#x44B;
          &#x442;&#x435;&#x43A;&#x441;&#x442; &#x438;&#x437; &#x43F;&#x430;&#x440;&#x430;&#x43C;&#x435;&#x442;&#x440;&#x430;
          &quot;message&quot; &#x431;&#x443;&#x434;&#x435;&#x442; &#x43F;&#x43E;&#x43A;&#x430;&#x437;&#x430;&#x43D;
          &#x43F;&#x43B;&#x430;&#x442;&#x435;&#x43B;&#x44C;&#x449;&#x438;&#x43A;&#x443;.</p>
      </td>
    </tr>
    <tr>
      <td style="text-align:left"><b>locale</b>
      </td>
      <td style="text-align:left">string</td>
      <td style="text-align:left">
        <p>&#x41D;&#x430;&#x441;&#x442;&#x440;&#x430;&#x438;&#x432;&#x430;&#x435;&#x442;
          &#x44F;&#x437;&#x44B;&#x43A; &#x432;&#x432;&#x43E;&#x434;&#x43D;&#x43E;&#x439;
          &#x447;&#x430;&#x441;&#x442;&#x438;.</p>
        <p><b>&#x412;&#x43E;&#x437;&#x43C;&#x43E;&#x436;&#x43D;&#x44B;&#x435; &#x437;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x44F;</b>:
          &quot;en&quot; &#x438;&#x43B;&#x438; &quot;ru&quot;. &#x41F;&#x43E; &#x443;&#x43C;&#x43E;&#x43B;&#x447;&#x430;&#x43D;&#x438;&#x44E;
          &quot;ru&quot;</p>
        <p></p>
        <p>&#x41D;&#x430;&#x43F;&#x440;&#x438;&#x43C;&#x435;&#x440;: &quot;&#x41C;&#x430;&#x433;&#x430;&#x437;&#x438;&#x43D;
          &#x43E;&#x442;&#x43A;&#x43B;&#x43E;&#x43D;&#x438;&#x43B; &#x43F;&#x43B;&#x430;&#x442;&#x435;&#x436;: <em>&#x43F;&#x440;&#x438;&#x447;&#x438;&#x43D;&#x430; &#x431;&#x43B;&#x43E;&#x43A;&#x438;&#x440;&#x43E;&#x432;&#x43A;&#x438;</em>&quot;,
          &#x433;&#x434;&#x435; &quot;&#x41C;&#x430;&#x433;&#x430;&#x437;&#x438;&#x43D;
          &#x43E;&#x442;&#x43A;&#x43B;&#x43E;&#x43D;&#x438;&#x43B; &#x43F;&#x43B;&#x430;&#x442;&#x435;&#x436;:&quot;
          - &#x432;&#x432;&#x43E;&#x434;&#x43D;&#x430;&#x44F; &#x447;&#x430;&#x441;&#x442;&#x44C;.
          &quot;<em>&#x41F;&#x440;&#x438;&#x447;&#x438;&#x43D;&#x430; &#x431;&#x43B;&#x43E;&#x43A;&#x438;&#x440;&#x43E;&#x432;&#x43A;&#x438;</em>&quot;
          - &#x437;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x435; &#x43F;&#x430;&#x440;&#x430;&#x43C;&#x435;&#x442;&#x440;&#x430;
          message</p>
      </td>
    </tr>
  </tbody>
</table>

**ВАЖНО:** на этапе PAY при любой ошибке \(например нет доступа к БД\) платеж получит статус «не завершен». После устранения проблем повторите платеж в статистике.

